#include "stm32f10x.h"
#include "stm32f10x_gpio.h"
#include "stm32f10x_rcc.h"
#include "stm32f10x_tim.h"
#include "stm32f10x_spi.h"
#include "stm32f10x_dma.h"
#include <misc.h>

#include <stdio.h>
#include <math.h>

//FreeRTOS:

#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include "semphr.h"


#include "tablo_parser.h"
#include "spi_bus.h"
#include "tablo.h"
#include "proto.h"

extern struct tablo tab;//структура табло
static void Init_Task(void *pvParameters);//инициализация и тест индикаторов
const uint8_t test_frame_1[]={0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x00,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x07,0x5D};
const uint8_t test_frame_2[]={0x3A,0x7C,0x5B,0x00,0x38,0x38,0x38,0x5D,0x5B,0x01,0x38,0x38,0x38,0x5D,0x5B,0x02,0x38,0x38,0x38,0x5D,0x5B,0x03,0x38,0x38,0x38,0x5D,0x5B,0x04,0x38,0x38,0x38,0x5D,0x5B,0x05,0x38,0x38,0x38,0x5D,0x5B,0x06,0x38,0x38,0x38,0x5D,0x5B,0x07,0x38,0x38,0x38,0x5D,0x5B,0x08,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0A,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0B,0x38,0x38,0x38,0x5D,0x5B,0x0C,0x38,0x38,0x38,0x38,0x38,0x5D,0x5B,0x0D,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0E,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x0F,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x10,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x12,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x13,0x01,0x20,0xFF,0xFF,0x5D,0x5B,0x2A,0x07,0x5D};
static void Init_Task(void *pvParameters)
{
	uint8_t i=0;

	spi1_config();
	spi2_config();
//	spi3_config();



	tablo_devices_init();

	//1 кадр
	tablo_proto_parser(&test_frame_1);

	vTaskDelay(2000);

	//2 кадр
	tablo_proto_parser(&test_frame_2);

	vTaskDelay(2000);

    Proto_Init();
    vTaskDelete( NULL );

}

int main(void)
{
	SystemInit();


	 xTaskCreate(Init_Task,(signed char*)"INIT",64,NULL, tskIDLE_PRIORITY + 1, NULL);

	//spi1_config();
	//spi2_config();
////	spi3_config();
////
	//tablo_devices_init();
//
   // Proto_Init();

    vTaskStartScheduler();

    while(1);
}
